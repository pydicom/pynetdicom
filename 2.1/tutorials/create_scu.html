<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing your first SCU &mdash; pynetdicom 2.1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/pynetdicom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/pynetdicom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=20623aea"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing your first SCP" href="create_scp.html" />
    <link rel="prev" title="How to install pynetdicom" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pynetdicom
              <img src="../_static/pydicom_flat_black.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">How to install pynetdicom</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing your first SCU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dicom-networking">DICOM networking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-an-scu">What <em>is</em> an SCU?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#start-the-echo-scp">Start the Echo SCP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-an-application-entity-and-associate">Create an Application Entity and associate</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting-associations">Troubleshooting associations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-echo-scu">Creating the Echo SCU</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#presentation-contexts">Presentation Contexts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#turning-our-ae-into-an-echo-scu">Turning our AE into an Echo SCU</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="create_scp.html">Writing your first SCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="register_sop_class.html">Registering a new SOP Class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../service_classes/index.html">Supported Service Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Code Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apps/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pynetdicom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Writing your first SCU</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-your-first-scu">
<h1>Writing your first SCU<a class="headerlink" href="#writing-your-first-scu" title="Link to this heading">¶</a></h1>
<p>This tutorial is intended for people who are new to <em>pynetdicom</em>. In it you’ll:</p>
<ul class="simple">
<li><p>Learn a bit about the basics of DICOM networking</p></li>
<li><p>Learn how to use the <a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a> application
that comes with <em>pynetdicom</em></p></li>
<li><p>Create an new application entity (AE) and associate with a DICOM peer</p></li>
<li><p>Learn how to perform some basic troubleshooting of associations</p></li>
<li><p>Modify your AE to be an Echo SCU</p></li>
</ul>
<p>The tutorial is written for <em>pynetdicom</em> 2.0 and higher, which supports Python
3.7+. You can tell which version of <em>pynetdicom</em> you have by running
the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m pynetdicom --version
</pre></div>
</div>
<p>If you get an error or if your version is earlier than 2.0, then install or
upgrade <em>pynetdicom</em> by following the instructions in the
<a class="reference internal" href="installation.html"><span class="doc">installation guide</span></a>. For
this tutorial we’ll also be using the <a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a>
application that comes with <em>pynetdicom</em>.</p>
<section id="dicom-networking">
<h2>DICOM networking<a class="headerlink" href="#dicom-networking" title="Link to this heading">¶</a></h2>
<p><em>pynetdicom</em> is an implementation of the <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/chapter_9.html">DICOM Upper Layer Protocol for
TCP/IP</a>, which is used to facilitate communication
between DICOM <em>Application Entities</em> (AEs) over a <a class="reference external" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP connection</a>. Communication
between two AEs starts by establishing a TCP connection, then progresses to
negotiating an <em>association</em>, which is the term used to describe the
communications channel between the AEs and the set of rules that govern their
expected behaviour.</p>
<p>The AE that initiated the connection, the <em>requestor</em>, sends an
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/sect_9.3.2.html">A-ASSOCIATE-RQ</a> message proposing which
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/PS3.4.html">DICOM services</a> it would like
to use. The receiving AE, the <em>acceptor</em>, goes through the proposal and either:</p>
<ul class="simple">
<li><p>Accepts the association and replies with an <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/sect_9.3.3.html">A-ASSOCIATE-AC</a> message. However, just because an association has
been accepted doesn’t mean that the proposed services have also been
accepted.</p></li>
<li><p>Rejects the association by replying with an <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/sect_9.3.4.html">A-ASSOCIATE-RJ</a> message.</p></li>
<li><p>Aborts the association negotiation by sending an <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/sect_9.3.8.html">A-ABORT</a> message.</p></li>
</ul>
<p>When the <em>requestor</em> receives the A-ASSOCIATE-AC message the negotiation phase
ends and the association becomes <em>established</em>. The two AEs can then
use the services that were agreed upon during negotiation by exchanging
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/sect_7.5.html#sect_7.5.1">DIMSE-C</a> and <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/sect_7.5.2.html">DIMSE-N</a> messages.</p>
<p>When the association is no longer needed, it can be released by sending an
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part08/sect_9.3.6.html">A-RELEASE-RQ</a> message. The association can be
also be aborted at any time when either AE sends an A-ABORT message. Once
the association has been aborted or released, the TCP connection is closed
(if still open) and communication between the two AEs ends.</p>
<section id="what-is-an-scu">
<h3>What <em>is</em> an SCU?<a class="headerlink" href="#what-is-an-scu" title="Link to this heading">¶</a></h3>
<p>If you’re new to DICOM, you might be wondering what an Echo SCU or SCP actually
<em>are</em>. The answer lies in the DICOM services that are available to an
association; if an AE <em>provides</em> a service then it’s referred to as a <em>Service
Class Provider</em>, or SCP, while if an AE <em>uses</em> a service then it’s a <em>Service
Class User</em>, or SCU. A <em>Verification SCU</em> then, is an AE that uses the DICOM
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/chapter_A.html">verification service</a>, a <em>Storage SCP</em> is an AE
that provides the DICOM <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/chapter_B.html">storage service</a>, and so
on. Because the verification service is the sole user of
the DIMSE <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/chapter_9.html#sect_9.1.5">C-ECHO</a> messages, the
labels “Verification SCU” and “Verification SCP”
are frequently shortened to “Echo SCU” and “Echo SCP” instead.</p>
<p>The verification service itself is used to verify basic DICOM connectivity
between two AEs; the Echo SCU sends a <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/sect_9.3.5.html#sect_9.3.5.1">C-ECHO request</a> to the SCP, which
replies with an acknowledgement. By doing this you can test
whether a DICOM application is active and reachable by your SCU, that your
configuration is correct and that the connection isn’t being blocked by a
firewall or anything else.</p>
<p>OK, enough about DICOM networking, let’s get started.</p>
</section>
</section>
<section id="start-the-echo-scp">
<h2>Start the Echo SCP<a class="headerlink" href="#start-the-echo-scp" title="Link to this heading">¶</a></h2>
<p>For this tutorial we need an Echo SCP. To make things simpler we’ll use the
<a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a> application that comes with
<em>pynetdicom</em>, but you could also use any third-party application that supports
the verification service as an SCP, such as DCMTK’s
<a class="reference external" href="https://support.dcmtk.org/docs/storescp.html">storescp</a>. To find out if
an application supports the verification service you should check their
DICOM conformance statement.</p>
<p>In a new terminal, start <a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a> listening for
connection requests on
port <code class="docutils literal notranslate"><span class="pre">11112</span></code> with the <code class="docutils literal notranslate"><span class="pre">-v</span></code> verbose flag (or you could use the <code class="docutils literal notranslate"><span class="pre">-d</span></code> debug
flag for even more output):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python -m pynetdicom echoscp 11112 -v
</pre></div>
</div>
<p>If you get an error saying the address is already in use, try again
with a different port - just remember to adapt the port used when making
association requests accordingly. Depending on your OS or system configuration
you may also need to allow access through the firewall for the port you end
up using.</p>
<p>The SCP will continue to run until you interrupt it, either by closing the
terminal or by pressing <code class="docutils literal notranslate"><span class="pre">CTRL+C</span></code>. Keep the application running in the
background for the rest of the tutorial, but you may wish to look at its
output every now and then to get a feel for what’s happening at the other
end of the association.</p>
</section>
<section id="create-an-application-entity-and-associate">
<h2>Create an Application Entity and associate<a class="headerlink" href="#create-an-application-entity-and-associate" title="Link to this heading">¶</a></h2>
<p>Next we’re going to make a new application entity and request an association
with the Echo SCP. Create a new file <code class="docutils literal notranslate"><span class="pre">my_scu.py</span></code>, open it in a text
editor and add the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span> <span class="kn">from</span> <span class="nn">pynetdicom</span> <span class="kn">import</span> <span class="n">AE</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span> <span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>
<span class="linenos"> 4</span> <span class="n">ae</span><span class="o">.</span><span class="n">add_requested_context</span><span class="p">(</span><span class="s2">&quot;1.2.840.10008.1.1&quot;</span><span class="p">)</span>
<span class="linenos"> 5</span> <span class="n">assoc</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">)</span>
<span class="linenos"> 6</span> <span class="k">if</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
<span class="linenos"> 7</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Association established with Echo SCP!&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>     <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="linenos"> 9</span> <span class="k">else</span><span class="p">:</span>
<span class="linenos">10</span>     <span class="c1"># Association rejected, aborted or never connected</span>
<span class="linenos">11</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to associate&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There’s a lot going on in these few lines, so let’s split it up a bit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span> <span class="kn">from</span> <span class="nn">pynetdicom</span> <span class="kn">import</span> <span class="n">AE</span>
<span class="linenos">2</span>
<span class="linenos">3</span> <span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>
<span class="linenos">4</span> <span class="n">ae</span><span class="o">.</span><span class="n">add_requested_context</span><span class="p">(</span><span class="s2">&quot;1.2.840.10008.1.1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This imports the <a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity" title="pynetdicom.ae.ApplicationEntity"><code class="xref py py-class docutils literal notranslate"><span class="pre">AE</span></code></a> class, creates a new
<code class="docutils literal notranslate"><span class="pre">AE</span></code> instance, <cite>ae</cite>, then adds a single
<a class="reference internal" href="../user/presentation.html"><span class="doc">presentation context</span></a> with an abstract syntax of
<code class="docutils literal notranslate"><span class="pre">&quot;1.2.840.10008.1.1&quot;</span></code> using the <a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity.add_requested_context" title="pynetdicom.ae.ApplicationEntity.add_requested_context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_requested_context()</span></code></a>
method.  All association requests must contain at least one presentation context,
and in this case we’ve proposed one with the abstract syntax for the verification service.
We’ll go into presentation contexts and how they’re used to define an
association’s services a bit more later on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">5</span> <span class="n">assoc</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we initiate the association negotiation by connecting to the IP address
<code class="docutils literal notranslate"><span class="pre">&quot;127.0.0.1&quot;</span></code> on port <code class="docutils literal notranslate"><span class="pre">11112</span></code> and sending an association request.
<code class="docutils literal notranslate"><span class="pre">&quot;127.0.0.1&quot;</span></code> (also known as <code class="docutils literal notranslate"><span class="pre">&quot;localhost&quot;</span></code>) is a <a class="reference external" href="https://en.wikipedia.org/wiki/Localhost">special IP address</a> that means <em>this computer</em>. This
should be the same IP address and port that you started the
<a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a> application on earlier, so if you used a
different port you should change this value accordingly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the SCP isn’t running on your local computer, you call
<a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity.associate" title="pynetdicom.ae.ApplicationEntity.associate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AE.associate()</span></code></a> using
the actual IP address and listen port of the SCP, for example
<code class="docutils literal notranslate"><span class="pre">ae.associate(&quot;148.60.155.4&quot;,</span> <span class="pre">104)</span></code>.</p>
</div>
<p>The <a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity.associate" title="pynetdicom.ae.ApplicationEntity.associate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AE.associate()</span></code></a> method returns an
<a class="reference internal" href="../reference/generated/pynetdicom.association.Association.html#pynetdicom.association.Association" title="pynetdicom.association.Association"><code class="xref py py-class docutils literal notranslate"><span class="pre">Association</span></code></a> instance <cite>assoc</cite>, which is a subclass of
<a class="reference external" href="https://docs.python.org/3/library/threading.html#threading.Thread" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">threading.Thread</span></code></a>. This allows us to make use of the
association while <em>pynetdicom</em> monitors the connection behind the scenes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 6</span> <span class="k">if</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
<span class="linenos"> 7</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Association established with Echo SCP!&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>     <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="linenos"> 9</span> <span class="k">else</span><span class="p">:</span>
<span class="linenos">10</span>     <span class="c1"># Association rejected, aborted or never connected</span>
<span class="linenos">11</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to associate&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As mentioned earlier, an <em>acceptor</em> may do a couple of things in response to an
association request; accept it, reject it or abort the negotiation entirely.
The request may also fail because there’s nothing there to associate with (a
connection failure).</p>
<p>Because there’s more than one possible outcome to negotiation, we check to
see if the association has been established using
<a class="reference internal" href="../reference/generated/pynetdicom.association.Association.html#pynetdicom.association.Association.is_established" title="pynetdicom.association.Association.is_established"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_established</span></code></a>. If it
is, we print a message and send an association
release request using <a class="reference internal" href="../reference/generated/pynetdicom.association.Association.html#pynetdicom.association.Association.release" title="pynetdicom.association.Association.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">release()</span></code></a>. This ends the
association and closes the connection with the Echo SCP. On the other hand,
if we failed to establish an association for whatever reason, the
connection is closed automatically (if required), and we don’t need to do
anything further.</p>
<p>If you don’t release the association yourself then it’ll remain established
until the connection is closed, usually when a timeout expires on
either the <em>requestor</em> or <em>acceptor</em> AE.</p>
<p>So, let’s see what happens when we run our code. Open a new terminal and
run the file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python my_scu.py
</pre></div>
</div>
<p>If everything worked correctly, you should see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Association established with Echo SCP
</pre></div>
</div>
<p>And if you take a look at the output for <a class="reference internal" href="../apps/echoscp.html"><span class="doc">echoscp</span></a> you
should see it accept
the association request and notify you of its release:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>I: Accepting Association
I: Association Released
</pre></div>
</div>
<p>If instead you saw <code class="docutils literal notranslate"><span class="pre">Failed</span> <span class="pre">to</span> <span class="pre">associate</span></code> then not to worry; make sure the
Echo SCP is running and your code is correct. If you still can’t
associate, move on to the next section on troubleshooting associations.</p>
<section id="troubleshooting-associations">
<h3>Troubleshooting associations<a class="headerlink" href="#troubleshooting-associations" title="Link to this heading">¶</a></h3>
<p>By itself our output isn’t very helpful in understanding what’s going on.
Fortunately <em>pynetdicom</em> has lots of logging output, but by default its
configured to send it all to the <a class="reference external" href="https://docs.python.org/3/library/logging.handlers.html#logging.NullHandler" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">NullHandler</span></code></a> which prevents
warnings and errors being printed to <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code>. This can be undone by
importing <a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">logging</span></code></a> and setting <code class="docutils literal notranslate"><span class="pre">logging.getLogger(&quot;pynetdicom&quot;).handlers</span> <span class="pre">=</span> <span class="pre">[]</span></code>
or by adding your own logging handlers.</p>
<p>If you need to troubleshoot, then a quick way to send the debugging output to
<code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> is by calling <a class="reference internal" href="../reference/generated/pynetdicom.debug_logger.html#pynetdicom.debug_logger" title="pynetdicom.debug_logger"><code class="xref py py-func docutils literal notranslate"><span class="pre">debug_logger()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span> <span class="kn">from</span> <span class="nn">pynetdicom</span> <span class="kn">import</span> <span class="n">AE</span><span class="p">,</span> <span class="n">debug_logger</span>
</span><span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span> <span class="n">debug_logger</span><span class="p">()</span>
</span><span class="linenos">4</span>
<span class="linenos">5</span> <span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>
<span class="linenos">6</span> <span class="n">ae</span><span class="o">.</span><span class="n">add_requested_context</span><span class="p">(</span><span class="s2">&quot;1.2.840.10008.1.1&quot;</span><span class="p">)</span>
<span class="linenos">7</span> <span class="n">assoc</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">)</span>
<span class="linenos">8</span> <span class="k">if</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
<span class="linenos">9</span>     <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
<p>If you save the changes and run <code class="docutils literal notranslate"><span class="pre">my_scu.py</span></code> again you’ll see much more
information:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ python my_scu.py
I: Requesting Association
D: Request Parameters:
D: ======================= OUTGOING A-ASSOCIATE-RQ PDU ========================
D: Our Implementation Class UID:      1.2.826.0.1.3680043.9.3811.2.0.0
D: Our Implementation Version Name:   PYNETDICOM_200
D: Application Context Name:    1.2.840.10008.3.1.1.1
D: Calling Application Name:    PYNETDICOM
D: Called Application Name:     ANY-SCP
D: Our Max PDU Receive Size:    16382
D: Presentation Context:
D:   Context ID:        1 (Proposed)
D:     Abstract Syntax: =Verification SOP Class
D:     Proposed SCP/SCU Role: Default
D:     Proposed Transfer Syntaxes:
D:       =Implicit VR Little Endian
D:       =Explicit VR Little Endian
D:       =Explicit VR Big Endian
D: Requested Extended Negotiation: None
D: Requested Common Extended Negotiation: None
D: Requested Asynchronous Operations Window Negotiation: None
D: Requested User Identity Negotiation: None
D: ========================== END A-ASSOCIATE-RQ PDU ==========================
D: Accept Parameters:
D: ======================= INCOMING A-ASSOCIATE-AC PDU ========================
D: Their Implementation Class UID:    1.2.826.0.1.3680043.9.3811.2.0.0
D: Their Implementation Version Name: PYNETDICOM_200
D: Application Context Name:    1.2.840.10008.3.1.1.1
D: Calling Application Name:    PYNETDICOM
D: Called Application Name:     ANY-SCP
D: Their Max PDU Receive Size:  16382
D: Presentation Contexts:
D:   Context ID:        1 (Accepted)
D:     Abstract Syntax: =Verification SOP Class
D:     Accepted SCP/SCU Role: Default
D:     Accepted Transfer Syntax: =Explicit VR Little Endian
D: Accepted Extended Negotiation: None
D: Accepted Asynchronous Operations Window Negotiation: None
D: User Identity Negotiation Response: None
D: ========================== END A-ASSOCIATE-AC PDU ==========================
I: Association Accepted
I: Releasing Association
</pre></div>
</div>
<p>Here you can see the stages of the association:</p>
<ol class="arabic simple">
<li><p>The association negotiation is initiated by sending an A-ASSOCIATE-RQ
message</p></li>
<li><p>An A-ASSOCIATE-AC message is received and the association accepted</p></li>
<li><p>The association is released.</p></li>
</ol>
<p>In general, the debugging log can be broken down into a couple of categories:</p>
<ul class="simple">
<li><p>Information about the state of the association and services, usually
prefixed by <code class="docutils literal notranslate"><span class="pre">I:</span></code></p></li>
<li><p>Errors and exceptions that have occurred, prefixed by <code class="docutils literal notranslate"><span class="pre">E:</span></code></p></li>
<li><p>The contents of various association related messages,
such as the A-ASSOCIATE-RQ and A-ASSOCIATE-AC messages, as well as
summaries of exchanged DIMSE messages (not shown here), usually prefixed by
<code class="docutils literal notranslate"><span class="pre">D:</span></code></p></li>
</ul>
<p>The first step to troubleshooting an association should be to look at the debug
output. Some common reasons for an association failure are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TCP</span> <span class="pre">Initialisation</span> <span class="pre">Error:</span> <span class="pre">Connection</span> <span class="pre">refused</span></code> indicates that nothing is
listening on the IP address and port you specified. Check they’re correct,
that the SCP is up and running, and that the firewall is allowing traffic
through.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Called</span> <span class="pre">AE</span> <span class="pre">title</span> <span class="pre">not</span> <span class="pre">recognised</span></code>: indicates that the SCP requires the
A-ASSOCIATE-RQ’s <em>Called AE Title</em> value match its own. This can
be set with the <em>ae_title</em> keyword parameter in
<a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity.associate" title="pynetdicom.ae.ApplicationEntity.associate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">associate()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Calling</span> <span class="pre">AE</span> <span class="pre">title</span> <span class="pre">not</span> <span class="pre">recognised</span></code>: indicates that the SCP requires the
A-ASSOCIATE-RQ’s <em>Calling AE Title</em> value match one its familiar with. This
can be set with the <a class="reference internal" href="../reference/generated/pynetdicom.ae.ApplicationEntity.html#pynetdicom.ae.ApplicationEntity.ae_title" title="pynetdicom.ae.ApplicationEntity.ae_title"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AE.ae_title</span></code></a>
property. Alternatively, you may need to configure the SCP with the details
of your SCU</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Local</span> <span class="pre">limit</span> <span class="pre">exceeded</span></code>: The SCP has too many current associations active,
try again later</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Association</span> <span class="pre">Aborted</span></code>: this is more unusual during association negotiation,
typically it’s seen afterwards or during DIMSE messaging. It may be due to
the SCP using TLS or other methods to secure the connection</p></li>
</ul>
<p>Hopefully by this point you’ve managed to get your AE associating with the SCP,
so let’s turn it into an Echo SCU.</p>
</section>
</section>
<section id="creating-the-echo-scu">
<h2>Creating the Echo SCU<a class="headerlink" href="#creating-the-echo-scu" title="Link to this heading">¶</a></h2>
<section id="presentation-contexts">
<h3>Presentation Contexts<a class="headerlink" href="#presentation-contexts" title="Link to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>What follows is a basic introduction to presentation contexts. More
information is available in the
<a class="reference internal" href="../user/presentation.html"><span class="doc">presentation contexts</span></a> section of the User
Guide.</p>
</div>
<p>We’ve cheated a little bit in our code by including a presentation context
used to propose the use of the verification service;
<code class="docutils literal notranslate"><span class="pre">1.2.840.10008.1.1</span></code> - <em>Verification SOP Class</em>. This is visible in the
debug output in the A-ASSOCIATE-RQ section as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="p">:</span> <span class="n">Presentation</span> <span class="n">Context</span><span class="p">:</span>
<span class="n">D</span><span class="p">:</span>   <span class="n">Context</span> <span class="n">ID</span><span class="p">:</span>        <span class="mi">1</span> <span class="p">(</span><span class="n">Proposed</span><span class="p">)</span>
<span class="n">D</span><span class="p">:</span>     <span class="n">Abstract</span> <span class="n">Syntax</span><span class="p">:</span> <span class="o">=</span><span class="n">Verification</span> <span class="n">SOP</span> <span class="n">Class</span>
<span class="n">D</span><span class="p">:</span>     <span class="n">Proposed</span> <span class="n">SCP</span><span class="o">/</span><span class="n">SCU</span> <span class="n">Role</span><span class="p">:</span> <span class="n">Default</span>
<span class="n">D</span><span class="p">:</span>     <span class="n">Proposed</span> <span class="n">Transfer</span> <span class="n">Syntaxes</span><span class="p">:</span>
<span class="n">D</span><span class="p">:</span>       <span class="o">=</span><span class="n">Implicit</span> <span class="n">VR</span> <span class="n">Little</span> <span class="n">Endian</span>
<span class="n">D</span><span class="p">:</span>       <span class="o">=</span><span class="n">Explicit</span> <span class="n">VR</span> <span class="n">Little</span> <span class="n">Endian</span>
<span class="n">D</span><span class="p">:</span>       <span class="o">=</span><span class="n">Explicit</span> <span class="n">VR</span> <span class="n">Big</span> <span class="n">Endian</span>
</pre></div>
</div>
<p>Presentation contexts are how DICOM applications agree on which services
are available to an association. Each DICOM service has a corresponding set of
<em>SOP Class UIDs</em> which can be found in the relevant sections of <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part03/PS3.3.html">Part 3 of
the DICOM Standard</a>. Setting one of these as the <em>abstract
syntax</em> parameter in a proposed presentation context indicates to the
<em>acceptor</em> that the corresponding service is requested for data matching that
SOP class. Additionally, the presentation context includes a description on
how any exchanged data is to be encoded, its <em>transfer syntax</em>.</p>
<p>So if you want to use the DICOM <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/chapter_A.html">verification</a>
service, you propose a presentation context for the <em>Verification SOP Class</em>.
If you wanted to use the <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/chapter_B.html">storage</a> service
to store <em>CT Images</em>, you’d propose a presentation context for the <em>CT Image
Storage</em> SOP class with a transfer syntax that matches the encoding of the
CT data.</p>
<p>When the <em>acceptor</em> receives the proposed presentation contexts it goes through
them one-by-one, either accepting or rejecting each. The results are visible
in the A-ASSOCIATE-AC section of the debug log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>D: Presentation Contexts:
D:   Context ID:        1 (Accepted)
D:     Abstract Syntax: =Verification SOP Class
D:     Accepted SCP/SCU Role: Default
D:     Accepted Transfer Syntax: =Explicit VR Little Endian
</pre></div>
</div>
<p>Here you can see that the context was accepted and any transferred data must
use <code class="docutils literal notranslate"><span class="pre">Explicit</span> <span class="pre">VR</span> <span class="pre">Little</span> <span class="pre">Endian</span></code> encoding. If a context is rejected and
you still try to use it, or if a context is accepted but your data isn’t
encoded with the same transfer syntax, you’ll get a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> exception
similar to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>No presentation context for &#39;CT Image Storage&#39; has been accepted by the peer with &#39;Implicit VR Little Endian&#39; transfer syntax for the SCU role
</pre></div>
</div>
</section>
<section id="turning-our-ae-into-an-echo-scu">
<h3>Turning our AE into an Echo SCU<a class="headerlink" href="#turning-our-ae-into-an-echo-scu" title="Link to this heading">¶</a></h3>
<p>Since we’re able to associate with the Echo SCP, our next step is to request
the use of it’s verification service. We do this by sending a DIMSE C-ECHO
request:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span> <span class="kn">from</span> <span class="nn">pynetdicom</span> <span class="kn">import</span> <span class="n">AE</span><span class="p">,</span> <span class="n">debug_logger</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span> <span class="n">debug_logger</span><span class="p">()</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span> <span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>
<span class="linenos"> 6</span> <span class="n">ae</span><span class="o">.</span><span class="n">add_requested_context</span><span class="p">(</span><span class="s2">&quot;1.2.840.10008.1.1&quot;</span><span class="p">)</span>
<span class="linenos"> 7</span> <span class="n">assoc</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">)</span>
<span class="linenos"> 8</span> <span class="k">if</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
<span class="hll"><span class="linenos"> 9</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_echo</span><span class="p">()</span>
</span><span class="linenos">10</span>     <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
<p>The only thing we need to change is to include a call to
<a class="reference internal" href="../reference/generated/pynetdicom.association.Association.html#pynetdicom.association.Association.send_c_echo" title="pynetdicom.association.Association.send_c_echo"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send_c_echo()</span></code></a>, which sends
the C-ECHO request and returns a <em>pydicom</em>
<a class="reference external" href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataset.Dataset.html#pydicom.dataset.Dataset" title="(in pydicom v2.4.4)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dataset</span></code></a> instance <em>status</em>. If we received a
response to our C-ECHO request, then <cite>status</cite> will contain at least an
(0000,0900) <em>Status</em> element containing the outcome of our request. If no
response was received (due to a connection failure, a timeout, or because the
association was aborted) then <cite>status</cite> will be an empty
<a class="reference external" href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataset.Dataset.html#pydicom.dataset.Dataset" title="(in pydicom v2.4.4)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dataset</span></code></a>.</p>
<p>The <em>Status</em> element value is a code that indicates the result of the C-ECHO
request. Each service class has a number of defined status codes which are
usually a mix of generic codes for each DIMSE message type and code values
specific to the service class. For example, if you look at the API reference
for <a class="reference internal" href="../reference/generated/pynetdicom.association.Association.html#pynetdicom.association.Association.send_c_store" title="pynetdicom.association.Association.send_c_store"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send_c_store()</span></code></a> you’ll see there are general
C-STORE status codes, such as <code class="docutils literal notranslate"><span class="pre">0x0000</span></code> (Success), as
well as service specific codes, such as <code class="docutils literal notranslate"><span class="pre">0xC000</span></code> (Failure - cannot
understand) for the storage
service. The API reference for each <code class="docutils literal notranslate"><span class="pre">Association.send_*</span></code> method contains a
list of possible status codes and their meaning.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Service specific status codes are defined in the corresponding sections of
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part03/PS3.3.html">Part 3</a> of the DICOM Standard, while the general
codes are in Sections <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/chapter_9.html">9</a> and
<a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/chapter_10.html">10</a> and <a class="reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part07/chapter_C.html">Annex C</a>
of Part 7.</p>
</div>
<p>If you run your modified code then at the end of the output you should see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>I: Association Accepted
I: Sending Echo Request: MsgID 1
D: pydicom.read_dataset() TransferSyntax=&quot;Little Endian Implicit&quot;
I: Received Echo Response (Status: 0x0000 - Success)
I: Releasing Association
</pre></div>
</div>
<p>The SCP has responded with a <code class="docutils literal notranslate"><span class="pre">Status:</span> <span class="pre">0x0000</span> <span class="pre">-</span> <span class="pre">Success</span></code>, which indicates that
the verification service request was successful. Congratulations, you’ve
written your first DICOM application using <em>pynetdicom</em>.</p>
</section>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Link to this heading">¶</a></h2>
<p>We recommend that you move on to <a class="reference internal" href="create_scp.html"><span class="doc">writing your first SCP</span></a>
next. However, you might also be interested in the
<a class="reference internal" href="../examples/index.html"><span class="doc">SCU examples</span></a> available in the documentation, or the
<a class="reference internal" href="../apps/index.html"><span class="doc">applications</span></a> that come with <em>pynetdicom</em>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="How to install pynetdicom" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="create_scp.html" class="btn btn-neutral float-right" title="Writing your first SCP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, pynetdicom contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>