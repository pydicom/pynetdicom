

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Query/Retrieve (Find) Service Examples &mdash; pynetdicom 3.0.0.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/pynetdicom.css?v=b0f7bde4" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/css/pynetdicom.css?v=b0f7bde4" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=afcbd73c"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Query/Retrieve (Get) Service Examples" href="qr_get.html" />
    <link rel="prev" title="Modality Performed Procedure Step Management Service Examples" href="mpps.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pynetdicom
              <img src="../_static/pydicom_flat_black.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service_classes/index.html">Supported Service Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Code Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic_worklist.html">Basic Worklist Management Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="display.html">Display System Management Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpps.html">Modality Performed Procedure Step Management Service Examples</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Query/Retrieve (Find) Service Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#query-retrieve-find-scu">Query/Retrieve (Find) SCU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-retrieve-find-scp">Query/Retrieve (Find) SCP</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="qr_get.html">Query/Retrieve (Get) Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="qr_move.html">Query/Retrieve (Move) Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="relevant_patient.html">Relevant Patient Information Query Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="print.html">Print Management Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage Service Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="verification.html">Verification Service Examples</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apps/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pynetdicom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Code Examples</a></li>
      <li class="breadcrumb-item active">Query/Retrieve (Find) Service Examples</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="query-retrieve-find-service-examples">
<h1>Query/Retrieve (Find) Service Examples<a class="headerlink" href="#query-retrieve-find-service-examples" title="Link to this heading">¶</a></h1>
<p>The DICOM <a class="extlink-dcm reference external" href="https://dicom.nema.org/medical/dicom/current/output/chtml/part04/chapter_C.html">Query/Retrieve Service</a>
provides a mechanism for a service user to query the SOP Instances managed
by a QR SCP. The QR (Find) SOP classes allow an SCU to receive a list of
attributes matching the requested query. This is accomplished through the
DIMSE C-FIND service.</p>
<section id="query-retrieve-find-scu">
<h2>Query/Retrieve (Find) SCU<a class="headerlink" href="#query-retrieve-find-scu" title="Link to this heading">¶</a></h2>
<p>Associate with a peer DICOM Application Entity and request the SCP search for
SOP Instances with a <em>Patient Name</em> matching <code class="docutils literal notranslate"><span class="pre">CITIZEN^Jan</span></code> using <em>Patient
Root Query/Retrieve Information Model - Find</em> at the <code class="docutils literal notranslate"><span class="pre">'PATIENT'</span></code> level.</p>
<p>The value of the <em>Query Retrieve Level</em> determines what SOP Instances are
actually transferred, you can find all the possible query level values in the
following table. In this example we are querying for all the available
data of a specific patient, so <code class="docutils literal notranslate"><span class="pre">'PATIENT'</span></code> level is the appropriate one.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Query Retrieve
Level</p></th>
<th class="head"><p>Effect</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PATIENT</p></td>
<td><p>All SOP Instances related to a patient shall be
transferred</p></td>
</tr>
<tr class="row-odd"><td><p>STUDY</p></td>
<td><p>All SOP Instances related to a study shall be
transferred</p></td>
</tr>
<tr class="row-even"><td><p>SERIES</p></td>
<td><p>All SOP Instances related to a series shall be
transferred</p></td>
</tr>
<tr class="row-odd"><td><p>IMAGE</p></td>
<td><p>Selected individual SOP Instances shall be transferred</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydicom.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pynetdicom</span><span class="w"> </span><span class="kn">import</span> <span class="n">AE</span><span class="p">,</span> <span class="n">debug_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pynetdicom.sop_class</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatientRootQueryRetrieveInformationModelFind</span>

<span class="n">debug_logger</span><span class="p">()</span>

<span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>
<span class="n">ae</span><span class="o">.</span><span class="n">add_requested_context</span><span class="p">(</span><span class="n">PatientRootQueryRetrieveInformationModelFind</span><span class="p">)</span>

<span class="c1"># Create our Identifier (query) dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
<span class="n">ds</span><span class="o">.</span><span class="n">PatientName</span> <span class="o">=</span> <span class="s1">&#39;CITIZEN^Jan&#39;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="s1">&#39;PATIENT&#39;</span>

<span class="c1"># Associate with the peer AE at IP 127.0.0.1 and port 11112</span>
<span class="n">assoc</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">)</span>
<span class="k">if</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
    <span class="c1"># Send the C-FIND request</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_find</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">PatientRootQueryRetrieveInformationModelFind</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C-FIND query status: 0x</span><span class="si">{0:04X}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection timed out, was aborted or received invalid response&#39;</span><span class="p">)</span>

    <span class="c1"># Release the association</span>
    <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Association rejected, aborted or never connected&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The responses received from the SCP are dependent on the <em>Identifier</em> dataset
keys and values, the Query/Retrieve level and the information model. For
example, provided the optional attribute <em>SOP Classes in Study</em> is supported,
the following query dataset should yield C-FIND responses containing
the various <em>SOP Class UIDs</em> that make are in each study for a patient with
<em>Patient ID</em> <code class="docutils literal notranslate"><span class="pre">1234567</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
<span class="n">ds</span><span class="o">.</span><span class="n">SOPClassesInStudy</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">PatientID</span> <span class="o">=</span> <span class="s1">&#39;1234567&#39;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">StudyInstanceUID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="s1">&#39;STUDY&#39;</span>
</pre></div>
</div>
</section>
<section id="query-retrieve-find-scp">
<span id="example-qrfind-scp"></span><h2>Query/Retrieve (Find) SCP<a class="headerlink" href="#query-retrieve-find-scp" title="Link to this heading">¶</a></h2>
<p>The following represents a toy implementation of a Query/Retrieve (Find) SCP
where the SCU has sent the following <em>Identifier</em> dataset under the <em>Patient
Root Query Retrieve Information Model - Find</em> context.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
<span class="n">ds</span><span class="o">.</span><span class="n">PatientName</span> <span class="o">=</span> <span class="s1">&#39;CITIZEN^Jan&#39;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="s1">&#39;PATIENT&#39;</span>
</pre></div>
</div>
<p>This is a very bad way of managing stored SOP Instances, in reality its
probably best to store the instance attributes in a database and run the
query against that, which is the approach taken by the
<a class="reference internal" href="../apps/qrscp.html"><span class="doc">qrscp application</span></a>.</p>
<p>Check the
<a class="reference internal" href="../reference/generated/pynetdicom._handlers.doc_handle_find.html#pynetdicom._handlers.doc_handle_find" title="pynetdicom._handlers.doc_handle_find"><code class="xref py py-func docutils literal notranslate"><span class="pre">handler</span> <span class="pre">implementation</span> <span class="pre">documentation</span></code></a>
to see the requirements for the <code class="docutils literal notranslate"><span class="pre">evt.EVT_C_FIND</span></code> handler.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

 <span class="kn">from</span><span class="w"> </span><span class="nn">pydicom</span><span class="w"> </span><span class="kn">import</span> <span class="n">dcmread</span>
 <span class="kn">from</span><span class="w"> </span><span class="nn">pydicom.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>

 <span class="kn">from</span><span class="w"> </span><span class="nn">pynetdicom</span><span class="w"> </span><span class="kn">import</span> <span class="n">AE</span><span class="p">,</span> <span class="n">evt</span>
 <span class="kn">from</span><span class="w"> </span><span class="nn">pynetdicom.sop_class</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatientRootQueryRetrieveInformationModelFind</span>

 <span class="c1"># Implement the handler for evt.EVT_C_FIND</span>
 <span class="k">def</span><span class="w"> </span><span class="nf">handle_find</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">     </span><span class="sd">&quot;&quot;&quot;Handle a C-FIND request event.&quot;&quot;&quot;</span>
     <span class="n">ds</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">identifier</span>

     <span class="c1"># Import stored SOP Instances</span>
     <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">fdir</span> <span class="o">=</span> <span class="s1">&#39;/path/to/directory&#39;</span>
     <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
         <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcmread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)))</span>

     <span class="k">if</span> <span class="s1">&#39;QueryRetrieveLevel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
         <span class="c1"># Failure</span>
         <span class="k">yield</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="kc">None</span>
         <span class="k">return</span>

     <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">==</span> <span class="s1">&#39;PATIENT&#39;</span><span class="p">:</span>
         <span class="k">if</span> <span class="s1">&#39;PatientName&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">PatientName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">]:</span>
                 <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span>
                     <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span> <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">PatientName</span> <span class="o">==</span> <span class="n">ds</span><span class="o">.</span><span class="n">PatientName</span>
                 <span class="p">]</span>

             <span class="c1"># Skip the other possible values...</span>

         <span class="c1"># Skip the other possible attributes...</span>

     <span class="c1"># Skip the other QR levels...</span>

     <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">matching</span><span class="p">:</span>
         <span class="c1"># Check if C-CANCEL has been received</span>
         <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_cancelled</span><span class="p">:</span>
             <span class="k">yield</span> <span class="p">(</span><span class="mh">0xFE00</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
             <span class="k">return</span>

         <span class="n">identifier</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
         <span class="n">identifier</span><span class="o">.</span><span class="n">PatientName</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">PatientName</span>
         <span class="n">identifier</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span>

         <span class="c1"># Pending</span>
         <span class="k">yield</span> <span class="p">(</span><span class="mh">0xFF00</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>

<span class="n">handlers</span> <span class="o">=</span> <span class="p">[(</span><span class="n">evt</span><span class="o">.</span><span class="n">EVT_C_FIND</span><span class="p">,</span> <span class="n">handle_find</span><span class="p">)]</span>

<span class="c1"># Initialise the Application Entity and specify the listen port</span>
<span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">()</span>

<span class="c1"># Add the supported presentation context</span>
<span class="n">ae</span><span class="o">.</span><span class="n">add_supported_context</span><span class="p">(</span><span class="n">PatientRootQueryRetrieveInformationModelFind</span><span class="p">)</span>

<span class="c1"># Start listening for incoming association requests</span>
<span class="n">ae</span><span class="o">.</span><span class="n">start_server</span><span class="p">((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">11112</span><span class="p">),</span> <span class="n">evt_handlers</span><span class="o">=</span><span class="n">handlers</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mpps.html" class="btn btn-neutral float-left" title="Modality Performed Procedure Step Management Service Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="qr_get.html" class="btn btn-neutral float-right" title="Query/Retrieve (Get) Service Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2025, pynetdicom contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>